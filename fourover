import os
import hmac
import hashlib
import requests
from urllib.parse import urlencode

FOUR_OVER_APIKEY = os.getenv("FOUR_OVER_APIKEY", "")
FOUR_OVER_PRIVATE_KEY = os.getenv("FOUR_OVER_PRIVATE_KEY", "")
FOUR_OVER_BASE_URL = os.getenv("FOUR_OVER_BASE_URL", "https://api.4over.com").rstrip("/")

DEFAULT_TIMEOUT = 30

def _require_env():
    missing = []
    if not FOUR_OVER_APIKEY:
        missing.append("FOUR_OVER_APIKEY")
    if not FOUR_OVER_PRIVATE_KEY:
        missing.append("FOUR_OVER_PRIVATE_KEY")
    if not FOUR_OVER_BASE_URL:
        missing.append("FOUR_OVER_BASE_URL")
    if missing:
        raise RuntimeError(f"Missing env vars: {', '.join(missing)}")

def _sign(canonical: str, private_key: str) -> str:
    """
    4over signature (HMAC-SHA256 hex) using the private key.
    Canonical string example from your logs:
      /whoami?apikey=catdi
    """
    return hmac.new(
        private_key.encode("utf-8"),
        canonical.encode("utf-8"),
        hashlib.sha256
    ).hexdigest()

def fourover_request(path: str, params: dict | None = None, apikey_override: str | None = None):
    """
    Generic signed GET request to 4over.

    Example:
      fourover_request("/whoami")
      fourover_request("/printproducts/categories")
      fourover_request("/printproducts/categories/<uuid>/products")
    """
    _require_env()
    params = params or {}

    apikey = apikey_override or FOUR_OVER_APIKEY

    # Always include apikey in query before signing
    q = {"apikey": apikey, **params}
    query = urlencode(q)

    canonical = f"{path}?{query}"
    signature = _sign(canonical, FOUR_OVER_PRIVATE_KEY)

    url = f"{FOUR_OVER_BASE_URL}{canonical}&signature={signature}"

    resp = requests.get(url, timeout=DEFAULT_TIMEOUT)

    # Helpful debugging on failure
    if resp.status_code >= 400:
        raise RuntimeError(
            f"HTTP {resp.status_code} from 4over. Body: {resp.text[:500]} | url: {url}"
        )

    # 4over typically returns JSON
    try:
        return resp.json()
    except Exception:
        return {"raw": resp.text}

def fourover_whoami():
    return fourover_request("/whoami")
